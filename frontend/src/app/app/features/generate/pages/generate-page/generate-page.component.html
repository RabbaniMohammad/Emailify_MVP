<div class="generate-layout">
<!-- LEFT: Live Preview (60%) -->
<section class="preview-section">
  <!-- ONLY Add: Title + Template Name + Save/Run Buttons -->
  <!-- <div class="generate-custom-header" *ngIf="hasTemplate() && !(isGenerating$ | async)">
    <div class="header-left">
      <h3>Generated Template</h3>
      <span class="status-badge">
        <mat-icon>check_circle</mat-icon>
        Ready
      </span>
    </div> -->
    
    <!-- Template Name Input -->
    <!-- <mat-form-field class="template-name-input" appearance="outline">
      <mat-label>Template Name</mat-label>
      <input 
        matInput 
        [(ngModel)]="templateName" 
        placeholder="My Email Template"
        maxlength="100">
    </mat-form-field> -->

    <!-- Save Button -->
    <!-- <button
      mat-raised-button
      class="save-btn"
      (click)="onSaveTemplate()"
      [disabled]="(isGenerating$ | async) ?? false">
      <mat-icon>save</mat-icon>
      Save Template
    </button> -->

    <!-- Run Tests Button -->
    <!-- <button
      mat-raised-button
      class="run-tests-btn"
      (click)="onRunTests()"
      [disabled]="(isGenerating$ | async) ?? false">
      <mat-icon>play_arrow</mat-icon>
      Run Tests
    </button>
  </div> -->

  <!-- Preview Wrapper -->
  <div class="preview-wrapper">
    <!-- Loading Overlay -->
    <div class="custom-loading-overlay" *ngIf="isGenerating$ | async">
      <!-- ... your loading animation ... -->
    </div>

    <!-- ⭐ ONE COMPONENT WITH EVERYTHING -->
<app-template-preview-panel
  *ngIf="!(isGenerating$ | async)"
  [html]="(currentHtml$ | async) || ''"
  [(templateName)]="templateName"
  [loading]="false"
  [showHeader]="true"
  [allowRefresh]="false"
  [allowFullscreen]="true"
  [allowViewModes]="true"
  [showGenerateActions]="true"
  [isGeneratePage]="true"
  (saveTemplate)="onSaveTemplate()"
  (runTests)="onRunTests()">
</app-template-preview-panel>
  </div>
</section>

  <!-- RIGHT: Chat Interface (40%) -->
  <section class="chat-section">
    <div class="chat-header">
      <div class="header-content">
        <mat-icon class="header-icon">auto_awesome</mat-icon>
        <div class="header-text">
          <h3>Template Generator</h3>
          <p>Powered by AI</p>
        </div>
      </div>

      <!-- New Conversation Button -->
      <button
        mat-icon-button
        class="new-chat-btn"
        (click)="onNewConversation()"
        matTooltip="Start New Conversation"
        [disabled]="(isGenerating$ | async) ?? false">
        <mat-icon>add_circle</mat-icon>
      </button>
    </div>

    <!-- Messages Container -->
    <div
  #messagesContainer
  class="chat-messages"
  (scroll)="onScroll($event)">
  <div
    *ngFor="let message of messages$ | async; trackBy: trackByIndex"
    class="chat-msg"
    [class.user-msg]="message.role === 'user'"
    [class.assistant-msg]="message.role === 'assistant'">
    <div class="bubble" [class.user-bubble]="message.role === 'user'">
      <div class="bubble-header">
        <span class="role">{{ message.role === 'user' ? 'You' : 'AI Assistant' }}</span>
        <span class="timestamp">{{ message.timestamp | date: 'short' }}</span>
      </div>
      
      <!-- ✅ Image attachments (if any) -->
      <div class="message-images" *ngIf="message.images && message.images.length > 0">
        <img 
          *ngFor="let img of message.images" 
          [src]="'data:' + img.mediaType + ';base64,' + img.data"
          [alt]="img.fileName"
          class="message-image">
      </div>
      
      <div class="bubble-content">
        {{ message.content }}
      </div>
    </div>
  </div>

  <!-- Generating Indicator -->
  <div class="chat-msg assistant-msg" *ngIf="isGenerating$ | async">
    <div class="bubble generating-bubble">
      <div class="bubble-header">
        <span class="role">AI Assistant</span>
      </div>
      <div class="bubble-content">
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span class="generating-text">Generating template...</span>
      </div>
    </div>
  </div>
</div>

    <!-- Message Composer -->
<!-- Message Composer -->
<div class="composer">
  <!-- Hidden file input -->
  <input 
    type="file"
    id="imageUploadInput"
    accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,image/svg+xml"
    multiple
    [attr.max]="maxImages"
    (change)="onImageSelect($event)"
    style="display: none;">

  <!-- Image Previews (if any) -->
  <div class="image-previews" *ngIf="imagePreviewUrls.length > 0">
    <div 
      *ngFor="let url of imagePreviewUrls; let i = index" 
      class="image-preview-item">
      <img [src]="url" alt="Upload preview">
      <button 
        class="remove-image-btn" 
        (click)="removeImage(i)"
        type="button">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <div class="composer-input-row">
    <!-- Plus Button for Image Upload -->
    <button
      mat-icon-button
      class="add-image-btn"
      (click)="triggerFileInput()"
      [disabled]="selectedImages.length >= maxImages || ((isGenerating$ | async) ?? false)"
      [matTooltip]="selectedImages.length >= maxImages ? 'Maximum 2 images' : 'Add design reference images'"
      matTooltipPosition="above"
      type="button">
      <mat-icon>add_photo_alternate</mat-icon>
    </button>

    <textarea
      #messageInput
      class="message-input"
      [(ngModel)]="userInput"
      (keydown.enter)="onEnterKey($event)"
      placeholder="Describe your email template... Upload design references for inspiration! 🎨"
      rows="3"
      [disabled]="(isGenerating$ | async) ?? false">
    </textarea>

    <button
      mat-raised-button
      class="send-btn"
      (click)="onSend()"
      [disabled]="!userInput.trim() || ((isGenerating$ | async) ?? false)">
      <mat-icon>send</mat-icon>
      <span>Send</span>
    </button>
  </div>
</div>
  </section>
</div>