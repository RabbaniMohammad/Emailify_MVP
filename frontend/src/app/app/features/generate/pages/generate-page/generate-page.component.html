<div class="generate-layout">
<!-- LEFT: Live Preview (60%) -->
<section class="preview-section">
  <!-- ONLY Add: Title + Template Name + Save/Run Buttons -->
  <!-- <div class="generate-custom-header" *ngIf="hasTemplate() && !(isGenerating$ | async)">
    <div class="header-left">
      <h3>Generated Template</h3>
      <span class="status-badge">
        <mat-icon>check_circle</mat-icon>
        Ready
      </span>
    </div> -->
    
    <!-- Template Name Input -->
    <!-- <mat-form-field class="template-name-input" appearance="outline">
      <mat-label>Template Name</mat-label>
      <input 
        matInput 
        [(ngModel)]="templateName" 
        placeholder="My Email Template"
        maxlength="100">
    </mat-form-field> -->

    <!-- Save Button -->
    <!-- <button
      mat-raised-button
      class="save-btn"
      (click)="onSaveTemplate()"
      [disabled]="(isGenerating$ | async) ?? false">
      <mat-icon>save</mat-icon>
      Save Template
    </button> -->

    <!-- QA Check Button -->
    <!-- <button
      mat-raised-button
      class="run-tests-btn"
      (click)="onRunTests()"
      [disabled]="(isGenerating$ | async) ?? false">
      <mat-icon>visibility</mat-icon>
      QA Check
    </button>
  </div> -->

  <!-- Preview Wrapper -->
  <div class="preview-wrapper">
    <!-- Template Preview (when generationType is 'template') -->
    <app-template-preview-panel
      *ngIf="generationType === 'template'"
      [html]="(currentHtml$ | async) || ''"
      [(templateName)]="templateName"
      [loading]="(isGenerating$ | async) ?? false"
      [showHeader]="true"
      [allowRefresh]="false"
      [allowFullscreen]="true"
      [allowViewModes]="true"
      [showGenerateActions]="true"
      [isGeneratePage]="true"
      (saveTemplate)="onSaveTemplate()"
      (runTests)="onRunTests()">
    </app-template-preview-panel>

    <!-- Image Gallery (when generationType is 'image') -->
    <div *ngIf="generationType === 'image'" class="image-gallery-wrapper">
      <div class="image-gallery-header">
        <h3>Generated Images</h3>
        <p class="subtitle">Powered by Ideogram 2.0</p>
      </div>

      <!-- Loading State -->
      <div *ngIf="isGeneratingImage" class="image-loading-state">
        <mat-spinner diameter="60"></mat-spinner>
        <p>Generating your image...</p>
      </div>

      <!-- Generated Images Grid -->
      <div *ngIf="!isGeneratingImage && generatedImages.length > 0" class="image-gallery-grid">
        <div *ngFor="let image of generatedImages" class="image-card">
          <img [src]="image.url" [alt]="image.prompt" class="generated-image">
          <div class="image-card-footer">
            <p class="image-prompt">{{ image.prompt }}</p>
            <div class="image-actions">
              <button mat-icon-button matTooltip="Download">
                <mat-icon>download</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Copy URL">
                <mat-icon>content_copy</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isGeneratingImage && generatedImages.length === 0" class="image-empty-state">
        <mat-icon>image</mat-icon>
        <h4>No Images Yet</h4>
        <p>Describe the image you want to generate in the chat below</p>
      </div>
    </div>
  </div>
</section>

  <!-- RIGHT: Chat Interface (40%) -->
  <section class="chat-section">
    <div class="chat-header">
      <div class="header-content">
        <!-- Email Template Icon -->
        <svg class="header-icon template-icon" 
             viewBox="0 0 24 24" 
             xmlns="http://www.w3.org/2000/svg">
          <path fill="white" d="M20,8L12,13L4,8V6L12,11L20,6M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C22,4.89 21.1,4 20,4Z"/>
        </svg>
        <div class="header-text">
          <h3>AI Generator</h3>
          <p>Powered by AI</p>
        </div>
      </div>

      <!-- New Conversation Button -->
      <button
        mat-icon-button
        class="new-chat-btn"
        (click)="onNewConversation()"
        matTooltip="Start New Conversation"
        [disabled]="(isGenerating$ | async) ?? false">
        <mat-icon>add_circle</mat-icon>
      </button>
      <!-- Usage Tips Button -->
<button
  mat-icon-button
  class="usage-tips-btn"
  [matMenuTriggerFor]="usageMenu"
  matTooltip="How to use">
  <mat-icon>auto_awesome</mat-icon>
</button>

<!-- Usage Tips Menu -->
<!-- Usage Tips Menu -->
<mat-menu #usageMenu="matMenu" class="usage-tips-menu">
  <div class="usage-tips-content" (click)="$event.stopPropagation()">
    <h4>üí° How to Use This Generator</h4>
    
    <div class="tip-section">
      <strong>Be Specific & Detailed</strong>
      <p>Describe what you want clearly - layout, colors, content sections, and purpose. The more details, the better the result.</p>
    </div>

    <div class="tip-section">
      <strong>üì∏ Add Design References</strong>
      <p>Upload images (max 2) for visual inspiration - colors, layout, style. We'll match the aesthetic while following your text instructions.</p>
    </div>

    <div class="tip-section">
      <strong>üîñ Request Placeholders</strong>
      <p>Ask for Mailchimp or other placeholders like <code>|*EMAIL*|</code>, <code>|*FNAME*|</code>, <code>|*COMPANY*|</code> - we'll add them where needed.</p>
    </div>

    <div class="tip-section">
      <strong>‚ú® Example Prompt:</strong>
      <p class="example">"Create a product launch email with a hero image, bold headline, 3-column feature grid, and a centered CTA button. Use purple (#6d28d9) and white colors. Add |*FNAME*| placeholder in greeting."</p>
    </div>

    <div class="tip-note">
      <!-- <mat-icon>mobile_friendly</mat-icon> -->
      All templates are mobile-first & responsive!
    </div>
  </div>
</mat-menu>
    </div>

    <!-- Generation Type Selector -->
    <div class="generation-type-selector">
      <div class="selector-wrapper">
        <label class="radio-option" [class.selected]="generationType === 'template'">
          <input 
            type="radio" 
            name="generationType" 
            value="template" 
            [(ngModel)]="generationType"
            (change)="onGenerationTypeChange('template')"
            [disabled]="(isGenerating$ | async) ?? false">
          <div class="option-content">
            <mat-icon>description</mat-icon>
            <span>Email Template</span>
          </div>
        </label>
        
        <label class="radio-option" [class.selected]="generationType === 'image'">
          <input 
            type="radio" 
            name="generationType" 
            value="image" 
            [(ngModel)]="generationType"
            (change)="onGenerationTypeChange('image')"
            [disabled]="(isGenerating$ | async) ?? false">
          <div class="option-content">
            <mat-icon>image</mat-icon>
            <span>AI Image</span>
          </div>
        </label>
      </div>
    </div>

    <!-- Messages Container -->
<!-- Messages Container -->
<div
  #messagesContainer
  class="chat-messages"
  (scroll)="onScroll($event)">
  
  <!-- Existing messages -->
  <div
    *ngFor="let message of messages$ | async; trackBy: trackByIndex"
    class="chat-msg"
    [class.user-msg]="message.role === 'user'"
    [class.assistant-msg]="message.role === 'assistant'">
    <div class="bubble" [class.user-bubble]="message.role === 'user'">
      <div class="bubble-header">
        <span class="role">{{ message.role === 'user' ? 'You' : 'AI Assistant' }}</span>
        <span class="timestamp">{{ message.timestamp | date: 'short' }}</span>
      </div>
      
      <!-- Images in sent messages -->
      <div class="message-images" *ngIf="message.images && message.images.length > 0">
        <img 
          *ngFor="let img of message.images" 
          [src]="'data:' + img.mediaType + ';base64,' + img.data"
          [alt]="img.fileName"
          class="message-image">
      </div>
      
      <!-- File Attachment in sent messages -->
      <div class="message-attachment" *ngIf="message.attachment">
        <div class="attachment-card">
          <div class="attachment-icon">
            <mat-icon>{{ getFileIcon(message.attachment.fileName) }}</mat-icon>
          </div>
          <div class="attachment-info">
            <span class="attachment-name">{{ message.attachment.fileName }}</span>
            <span class="attachment-size">{{ formatFileSize(message.attachment.fileSize) }}</span>
          </div>
        </div>
      </div>
      
      <div class="bubble-content">
        {{ message.content }}
      </div>
    </div>
  </div>

  <!-- Image Preview (before sending) -->
  <div class="chat-msg user-msg" *ngIf="imagePreviewUrls.length > 0 && !(isGenerating$ | async)">
    <div class="bubble user-bubble">
      <div class="bubble-header">
        <span class="role">Image Preview</span>
      </div>
      <div class="message-images preview-mode">
        <div *ngFor="let url of imagePreviewUrls; let i = index" class="image-wrapper">
          <img [src]="url" [alt]="'Preview ' + (i + 1)" class="message-image">
          <button class="remove-preview-btn" (click)="removeImage(i)" type="button">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- File Attachment Display (in chat) -->
  <div class="chat-msg user-msg" *ngIf="attachedFile">
    <div class="bubble user-bubble file-attachment-bubble">
      <div class="bubble-header">
        <span class="role">üìé Attached File</span>
        <button 
          mat-icon-button 
          class="remove-attachment-btn-inline"
          (click)="removeAttachedFile()"
          matTooltip="Remove attachment">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="file-attachment-content">
        <div class="file-icon-wrapper">
          <mat-icon class="file-icon">{{ getFileIcon(attachedFile.name) }}</mat-icon>
        </div>
        <div class="file-info">
          <span class="file-name">{{ attachedFile.name }}</span>
          <span class="file-size">{{ formatFileSize(attachedFile.size) }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Generating Indicator -->
  <div class="chat-msg assistant-msg" *ngIf="isGenerating$ | async">
    <div class="bubble generating-bubble">
      <div class="bubble-header">
        <span class="role">AI Assistant</span>
      </div>
      <div class="bubble-content">
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span class="generating-text">{{ isRegenerating ? 'Regenerating template...' : 'Generating template...' }}</span>
      </div>
    </div>
  </div>
</div>

    <!-- Message Composer -->
<!-- Message Composer -->
<!-- Message Composer -->
<div class="composer">
  <!-- Hidden file input -->
  <input 
    type="file"
    id="imageUploadInput"
    accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,image/svg+xml"
    multiple
    [attr.max]="maxImages"
    (change)="onImageSelect($event)"
    style="display: none;">

  <div class="composer-input-row">
    <!-- Attach Button -->
    <button
      mat-icon-button
      class="attach-btn"
      (click)="openAttachChoiceBanner()"
      [disabled]="(isGenerating$ | async) ?? false"
      matTooltip="Attach file"
      matTooltipPosition="above"
      type="button">
      <svg class="attach-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16.5 6V17.5C16.5 19.4891 14.9891 21 13 21C11.0109 21 9.5 19.4891 9.5 17.5V5C9.5 3.61929 10.6193 2.5 12 2.5C13.3807 2.5 14.5 3.61929 14.5 5V15.5C14.5 16.0523 14.0523 16.5 13.5 16.5C12.9477 16.5 12.5 16.0523 12.5 15.5V6H11V15.5C11 17.4891 12.5109 19 14.5 19C16.4891 19 18 17.4891 18 15.5V5C18 2.51472 15.9853 0.5 13.5 0.5C11.0147 0.5 9 2.51472 9 5V17.5C9 20.5376 11.4624 23 14.5 23C17.5376 23 20 20.5376 20 17.5V6H18.5Z" fill="currentColor"/>
      </svg>
    </button>

    <textarea
      #messageInput
      class="message-input"
      [(ngModel)]="userInput"
      (keydown.enter)="onEnterKey($event)"
      (paste)="onPaste($event)"
      rows="3">
    </textarea>

    <button
      mat-raised-button
      class="send-btn"
      (click)="onSend()"
      [disabled]="(!userInput.trim() && !attachedFile) || ((isGenerating$ | async) ?? false)">
      <mat-icon>send</mat-icon>
      <span>Send</span>
    </button>
  </div>
</div>
  </section>
</div>
<!-- Attach Choice Banner -->
<div class="attach-choice-overlay" *ngIf="showAttachChoiceBanner" (click)="closeAttachChoiceBanner()">
  <div class="attach-choice-content" (click)="$event.stopPropagation()">
    <!-- Close Button -->
    <button mat-icon-button class="close-btn" (click)="closeAttachChoiceBanner()">
      <mat-icon>close</mat-icon>
    </button>
    
    <!-- Banner Body -->
    <div class="attach-choice-body">
      <h2 class="attach-choice-title">üìé Attach File</h2>
      <p class="attach-choice-subtitle">Choose what you want to attach</p>
      
      <div class="attach-options">
        <button 
          mat-raised-button 
          class="attach-option-btn image-option"
          (click)="selectImageAttachment()">
          <mat-icon>image</mat-icon>
          <span>Image</span>
        </button>
        
        <button 
          mat-raised-button 
          class="attach-option-btn document-option"
          (click)="selectDocumentAttachment()">
          <mat-icon>description</mat-icon>
          <span>Document</span>
        </button>
        
        <button 
          mat-raised-button 
          class="attach-option-btn url-option"
          (click)="selectUrlAttachment()">
          <mat-icon>link</mat-icon>
          <span>Website URL</span>
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Website URL Analyzer Banner -->
<div class="url-analyzer-overlay" *ngIf="showUrlAnalyzer" (click)="closeUrlAnalyzer()">
  <div class="url-analyzer-content" (click)="$event.stopPropagation()">
    <!-- Close Button -->
    <button mat-icon-button class="close-btn" (click)="closeUrlAnalyzer()">
      <mat-icon>close</mat-icon>
    </button>
    
    <!-- Banner Body -->
    <div class="analyzer-body">
      <h2 class="analyzer-title">üåê Analyze Website</h2>
      <p class="analyzer-subtitle">Enter a website URL to extract brand colors, fonts, images, and content</p>
      
      <!-- URL Input Section -->
      <div *ngIf="!analyzedBrandDNA && !isAnalyzingWebsite" class="url-input-section">
        <mat-form-field class="url-input-field" appearance="outline">
          <mat-label>Website URL</mat-label>
          <input 
            matInput 
            [(ngModel)]="websiteUrl" 
            placeholder="https://example.com"
            (keydown.enter)="analyzeWebsite()"
            [disabled]="isAnalyzingWebsite">
          <mat-icon matPrefix>link</mat-icon>
        </mat-form-field>
        
        <button 
          mat-raised-button 
          class="analyze-btn"
          (click)="analyzeWebsite()"
          [disabled]="!websiteUrl || isAnalyzingWebsite">
          <mat-icon>search</mat-icon>
          <span>Analyze Website</span>
        </button>
      </div>
      
      <!-- Analyzing Indicator -->
      <div *ngIf="isAnalyzingWebsite" class="analyzing-section">
        <div class="modern-loader">
          <div class="loader-rings">
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>
            <div class="ring ring-3"></div>
          </div>
          <div class="loader-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
            </svg>
          </div>
        </div>
        <p class="analyzing-text">Analyzing website...</p>
        <p class="analyzing-subtext">Extracting colors, fonts, images, and content</p>
      </div>
      
      <!-- Brand DNA Review Section -->
      <div *ngIf="analyzedBrandDNA && !isAnalyzingWebsite" class="brand-dna-section">
        <div class="brand-dna-header">
          <h3>‚ú® Brand DNA Extracted</h3>
          <button mat-icon-button (click)="resetAnalyzer()" matTooltip="Analyze another website">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
        
        <!-- Logo -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.logo">
          <h4>üé® Brand Logo</h4>
          <div class="logo-display">
            <img [src]="analyzedBrandDNA.logo" alt="Brand Logo" class="brand-logo-img" (error)="onImageError($event)" />
            <div class="logo-url">
              <mat-icon class="url-icon">link</mat-icon>
              <span class="image-url" [title]="analyzedBrandDNA.logo">{{ getTruncatedUrl(analyzedBrandDNA.logo) }}</span>
            </div>
          </div>
        </div>
        
        <!-- Colors -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.colors && analyzedBrandDNA.colors.length > 0">
          <h4>üé® Color Palette</h4>
          <div class="color-palette">
            <div 
              *ngFor="let color of analyzedBrandDNA.colors; let i = index"
              class="color-item"
              [class.selected]="selectedColors.includes(color)"
              (click)="toggleColorSelection(color)">
              <div class="color-swatch" [style.background-color]="color"></div>
              <span class="color-code">{{ color }}</span>
              <mat-icon *ngIf="selectedColors.includes(color)" class="check-icon">check_circle</mat-icon>
            </div>
          </div>
        </div>
        
        <!-- Images -->
        <div class="dna-group">
          <h4 *ngIf="analyzedBrandDNA.images && analyzedBrandDNA.images.length > 0">
            üñºÔ∏è Images Found: {{ analyzedBrandDNA.images.length }} (Click to select, max 3)
          </h4>
          <h4 *ngIf="!analyzedBrandDNA.images || analyzedBrandDNA.images.length === 0">
            üñºÔ∏è Images
          </h4>
          
          <div *ngIf="analyzedBrandDNA.images && analyzedBrandDNA.images.length > 0" class="image-gallery">
            <div 
              *ngFor="let image of analyzedBrandDNA.images; let i = index"
              class="image-item-wrapper"
              [class.selected]="selectedBrandImages.includes(image)"
              (click)="toggleImageSelection(image)">
              <div class="image-item">
                <img [src]="image" [alt]="'Image ' + (i + 1)" (error)="onImageError($event)" />
                <mat-icon *ngIf="selectedBrandImages.includes(image)" class="check-icon">check_circle</mat-icon>
              </div>
              <div class="image-url-display">
                <mat-icon class="url-icon">link</mat-icon>
                <span class="image-url" [title]="image">{{ getTruncatedUrl(image) }}</span>
              </div>
            </div>
          </div>
          
          <div *ngIf="!analyzedBrandDNA.images || analyzedBrandDNA.images.length === 0" class="no-images-message">
            <mat-icon>image_not_supported</mat-icon>
            <p>No suitable images found on this page (min 100x100px)</p>
          </div>
        </div>
        
        <!-- Content Sections (Full Paragraphs) -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.contentSections && analyzedBrandDNA.contentSections.length > 0">
          <h4>üìÑ Website Content Sections ({{ analyzedBrandDNA.contentSections.length }} sections found)</h4>
          <div class="content-sections-list">
            <div 
              *ngFor="let section of analyzedBrandDNA.contentSections"
              class="content-section-item">
              <div class="section-header">
                <h5 *ngIf="section.heading">{{ section.heading }}</h5>
                <span class="section-context">{{ section.context }}</span>
              </div>
              <div class="section-paragraphs">
                <p *ngFor="let para of section.paragraphs" class="section-paragraph">{{ para }}</p>
              </div>
              <ul *ngIf="section.listItems && section.listItems.length > 0" class="section-list">
                <li *ngFor="let item of section.listItems" class="section-list-item">{{ item }}</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Content -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.content && analyzedBrandDNA.content.length > 0">
          <h4>‚úçÔ∏è Brand Voice & Content Snippets</h4>
          <div class="content-snippets">
            <div 
              *ngFor="let snippet of analyzedBrandDNA.content"
              class="snippet-item"
              [class.selected]="selectedContent.includes(snippet)"
              (click)="toggleContentSelection(snippet)">
              <p>{{ snippet }}</p>
              <mat-icon *ngIf="selectedContent.includes(snippet)" class="check-icon">check_circle</mat-icon>
            </div>
          </div>
        </div>
        
        <!-- Fonts -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.fonts">
          <h4>üî§ Typography</h4>
          <div class="fonts-display">
            <div class="font-item" *ngIf="analyzedBrandDNA.fonts.heading">
              <strong>Heading:</strong> {{ analyzedBrandDNA.fonts.heading }}
            </div>
            <div class="font-item" *ngIf="analyzedBrandDNA.fonts.body">
              <strong>Body:</strong> {{ analyzedBrandDNA.fonts.body }}
            </div>
          </div>
        </div>
        
        <!-- Brand Info -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.brandInfo && (analyzedBrandDNA.brandInfo.tagline || analyzedBrandDNA.brandInfo.mission || analyzedBrandDNA.brandInfo.values?.length > 0)">
          <h4>üí° Brand Identity</h4>
          <div class="brand-info-display">
            <div class="brand-info-item" *ngIf="analyzedBrandDNA.brandInfo.tagline">
              <strong>Tagline:</strong>
              <p>{{ analyzedBrandDNA.brandInfo.tagline }}</p>
            </div>
            <div class="brand-info-item" *ngIf="analyzedBrandDNA.brandInfo.mission">
              <strong>Mission:</strong>
              <p>{{ analyzedBrandDNA.brandInfo.mission }}</p>
            </div>
            <div class="brand-info-item" *ngIf="analyzedBrandDNA.brandInfo.values && analyzedBrandDNA.brandInfo.values.length > 0">
              <strong>Values:</strong>
              <div class="values-list">
                <span *ngFor="let value of analyzedBrandDNA.brandInfo.values" class="value-badge">{{ value }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Products -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.products && analyzedBrandDNA.products.length > 0">
          <h4>üõçÔ∏è Products ({{ analyzedBrandDNA.products.length }} found)</h4>
          <div class="products-list">
            <div 
              *ngFor="let product of analyzedBrandDNA.products"
              class="product-item">
              <div class="product-image" *ngIf="product.image">
                <img [src]="product.image" [alt]="product.name" (error)="onImageError($event)" />
              </div>
              <div class="product-details">
                <h5 class="product-name">{{ product.name }}</h5>
                <p class="product-price" *ngIf="product.price">{{ product.price }}</p>
                <p class="product-desc" *ngIf="product.description">{{ product.description }}</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Testimonials -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.testimonials && analyzedBrandDNA.testimonials.length > 0">
          <h4>üí¨ Testimonials ({{ analyzedBrandDNA.testimonials.length }} found)</h4>
          <div class="testimonials-list">
            <div 
              *ngFor="let testimonial of analyzedBrandDNA.testimonials"
              class="testimonial-item">
              <p class="testimonial-text">"{{ testimonial.text }}"</p>
              <div class="testimonial-meta" *ngIf="testimonial.author || testimonial.company">
                <span *ngIf="testimonial.author" class="author">‚Äî {{ testimonial.author }}</span>
                <span *ngIf="testimonial.company" class="company">{{ testimonial.company }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Contact Info -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.contact && (analyzedBrandDNA.contact.email || analyzedBrandDNA.contact.phone || analyzedBrandDNA.contact.address)">
          <h4>üìû Contact Information</h4>
          <div class="contact-display">
            <div class="contact-item" *ngIf="analyzedBrandDNA.contact.email">
              <mat-icon>email</mat-icon>
              <span>{{ analyzedBrandDNA.contact.email }}</span>
            </div>
            <div class="contact-item" *ngIf="analyzedBrandDNA.contact.phone">
              <mat-icon>phone</mat-icon>
              <span>{{ analyzedBrandDNA.contact.phone }}</span>
            </div>
            <div class="contact-item" *ngIf="analyzedBrandDNA.contact.address">
              <mat-icon>location_on</mat-icon>
              <span>{{ analyzedBrandDNA.contact.address }}</span>
            </div>
          </div>
        </div>
        
        <!-- CTAs with Links -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.ctas && analyzedBrandDNA.ctas.length > 0">
          <h4>üéØ Call-to-Actions ({{ analyzedBrandDNA.ctas.length }} found - Click to select)</h4>
          <div class="ctas-list">
            <div 
              *ngFor="let cta of analyzedBrandDNA.ctas"
              class="cta-item"
              [class.selected]="selectedCTAs.includes(cta)"
              (click)="toggleCTASelection(cta)">
              <div class="cta-text-wrapper">
                <mat-icon class="cta-icon">{{ cta.type === 'button' ? 'smart_button' : 'link' }}</mat-icon>
                <span class="cta-text">{{ cta.text }}</span>
              </div>
              <div class="cta-url">
                <mat-icon class="url-icon">link</mat-icon>
                <span [title]="cta.url">{{ getTruncatedUrl(cta.url) }}</span>
              </div>
              <mat-icon *ngIf="selectedCTAs.includes(cta)" class="check-icon">check_circle</mat-icon>
            </div>
          </div>
        </div>
        
        <!-- Social Links -->
        <div class="dna-group" *ngIf="analyzedBrandDNA.social && getSocialLinksCount(analyzedBrandDNA.social) > 0">
          <h4>üîó Social Media ({{ getSocialLinksCount(analyzedBrandDNA.social) }} found - Click to select)</h4>
          <div class="social-links-display">
            <div 
              *ngIf="analyzedBrandDNA.social.facebook" 
              class="social-link facebook"
              [class.selected]="isSocialLinkSelected('facebook')"
              (click)="toggleSocialLink('facebook', analyzedBrandDNA.social.facebook)">
              <mat-icon>facebook</mat-icon>
              <span>Facebook</span>
              <mat-icon *ngIf="isSocialLinkSelected('facebook')" class="check-icon-small">check_circle</mat-icon>
            </div>
            <div 
              *ngIf="analyzedBrandDNA.social.twitter" 
              class="social-link twitter"
              [class.selected]="isSocialLinkSelected('twitter')"
              (click)="toggleSocialLink('twitter', analyzedBrandDNA.social.twitter)">
              <mat-icon>close</mat-icon>
              <span>Twitter</span>
              <mat-icon *ngIf="isSocialLinkSelected('twitter')" class="check-icon-small">check_circle</mat-icon>
            </div>
            <div 
              *ngIf="analyzedBrandDNA.social.instagram" 
              class="social-link instagram"
              [class.selected]="isSocialLinkSelected('instagram')"
              (click)="toggleSocialLink('instagram', analyzedBrandDNA.social.instagram)">
              <mat-icon>camera_alt</mat-icon>
              <span>Instagram</span>
              <mat-icon *ngIf="isSocialLinkSelected('instagram')" class="check-icon-small">check_circle</mat-icon>
            </div>
            <div 
              *ngIf="analyzedBrandDNA.social.linkedin" 
              class="social-link linkedin"
              [class.selected]="isSocialLinkSelected('linkedin')"
              (click)="toggleSocialLink('linkedin', analyzedBrandDNA.social.linkedin)">
              <mat-icon>business</mat-icon>
              <span>LinkedIn</span>
              <mat-icon *ngIf="isSocialLinkSelected('linkedin')" class="check-icon-small">check_circle</mat-icon>
            </div>
            <div 
              *ngIf="analyzedBrandDNA.social.youtube" 
              class="social-link youtube"
              [class.selected]="isSocialLinkSelected('youtube')"
              (click)="toggleSocialLink('youtube', analyzedBrandDNA.social.youtube)">
              <mat-icon>play_circle</mat-icon>
              <span>YouTube</span>
              <mat-icon *ngIf="isSocialLinkSelected('youtube')" class="check-icon-small">check_circle</mat-icon>
            </div>
            <div 
              *ngIf="analyzedBrandDNA.social.tiktok" 
              class="social-link tiktok"
              [class.selected]="isSocialLinkSelected('tiktok')"
              (click)="toggleSocialLink('tiktok', analyzedBrandDNA.social.tiktok)">
              <mat-icon>music_note</mat-icon>
              <span>TikTok</span>
              <mat-icon *ngIf="isSocialLinkSelected('tiktok')" class="check-icon-small">check_circle</mat-icon>
            </div>
          </div>
        </div>
        
        <!-- Template Style Selection -->
        <div class="template-style-group">
          <h4>üéØ Select Template Style</h4>
          <div class="style-options">
            <button 
              *ngFor="let style of templateStyles"
              mat-stroked-button
              class="style-btn"
              [class.selected]="selectedTemplateStyle === style.value"
              (click)="selectTemplateStyle(style.value)">
              <mat-icon>{{ style.icon }}</mat-icon>
              <span>{{ style.label }}</span>
            </button>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="analyzer-actions">
          <button 
            mat-stroked-button 
            class="cancel-btn"
            (click)="resetAnalyzer()">
            <mat-icon>close</mat-icon>
            Cancel
          </button>
          <button 
            mat-raised-button 
            class="generate-prompt-btn"
            (click)="generatePromptFromBrandDNA()"
            [disabled]="!selectedTemplateStyle || isGeneratingPrompt">
            <div class="btn-loader" *ngIf="isGeneratingPrompt">
              <div class="spinner-ring"></div>
              <div class="spinner-ring ring-2"></div>
            </div>
            <mat-icon *ngIf="!isGeneratingPrompt">auto_awesome</mat-icon>
            <span>{{ isGeneratingPrompt ? 'Generating...' : 'Generate Prompt' }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CSV/Excel Upload Banner -->
<div class="csv-banner-overlay" *ngIf="showCsvBanner" (click)="closeCsvBanner()">
  <div class="csv-banner-content" (click)="$event.stopPropagation()">
    <!-- Close Button -->
    <button mat-icon-button class="close-btn" (click)="closeCsvBanner()">
      <mat-icon>close</mat-icon>
    </button>
    
    <!-- Banner Body -->
    <div class="banner-body">
      <h2 class="banner-title">üìÑ Upload Document</h2>
      <p class="banner-subtitle">Upload Excel, CSV, Word, or PDF to generate a smart email template prompt</p>
      
      <!-- File Upload Section (Show when no file uploaded or no prompt generated) -->
      <div *ngIf="!uploadedFile && !generatedPrompt" class="upload-section">
        <!-- Hidden file input -->
        <input 
          type="file"
          #fileInput
          accept=".xlsx,.xls,.csv,.doc,.docx,.pdf"
          (change)="onFileSelected($event)"
          style="display: none;">
        
        <!-- Drag & Drop Zone -->
        <div 
          class="drop-zone"
          (click)="fileInput.click()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onFileDrop($event)"
          [class.drag-over]="isDragOver">
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <p class="drop-text">Drag & drop your file here</p>
          <p class="drop-subtext">or click to browse</p>
          <p class="file-size-limit">Maximum size: 1MB</p>
          <div class="supported-formats">
            <span class="format-badge">Excel</span>
            <span class="format-badge">CSV</span>
            <span class="format-badge">Word</span>
            <span class="format-badge">PDF</span>
          </div>
        </div>
      </div>

      <!-- File Preview Section (Show when file is uploaded but prompt not generated) -->
      <div *ngIf="uploadedFile && !generatedPrompt" class="file-preview-section">
        <div class="file-preview-card">
          <div class="file-icon">
            <mat-icon>{{ getFileIcon(uploadedFile.name) }}</mat-icon>
          </div>
          <div class="file-details">
            <p class="file-name">{{ uploadedFile.name }}</p>
            <p class="file-size">{{ formatFileSize(uploadedFile.size) }}</p>
          </div>
          <button mat-icon-button class="remove-file-btn" (click)="removeUploadedFile()">
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" (click)="$event.stopPropagation()">
          <button 
            mat-raised-button 
            type="button"
            class="generate-prompt-btn"
            (click)="generatePromptFromFile(); $event.stopPropagation()"
            [disabled]="isGeneratingPrompt || isAttachingFile">
            <mat-spinner *ngIf="isGeneratingPrompt" diameter="20"></mat-spinner>
            <mat-icon *ngIf="!isGeneratingPrompt">auto_awesome</mat-icon>
            <span>{{ isGeneratingPrompt ? 'Generating...' : 'Generate Prompt (Recommended)' }}</span>
          </button>

          <button 
            mat-raised-button 
            type="button"
            class="use-in-chat-btn"
            (click)="useFileInChat(); $event.stopPropagation()"
            [disabled]="isGeneratingPrompt || isAttachingFile">
            <mat-spinner *ngIf="isAttachingFile" diameter="20"></mat-spinner>
            <mat-icon *ngIf="!isAttachingFile">attach_file</mat-icon>
            <span>{{ isAttachingFile ? 'Attaching...' : 'Attach Only' }}</span>
          </button>
        </div>
      </div>

      <!-- Prompt Display & Edit Section (Show when prompt is generated) -->
      <div *ngIf="generatedPrompt" class="prompt-section">
        <div class="prompt-header">
          <h3>‚ú® Generated Prompt</h3>
          <button mat-icon-button (click)="resetUpload()" matTooltip="Upload new file">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>

        <!-- Editable Prompt -->
        <textarea 
          class="prompt-textarea"
          [(ngModel)]="generatedPrompt"
          rows="10"
          placeholder="Edit your prompt here...">
        </textarea>

        <!-- Action Buttons -->
        <div class="prompt-actions">
          <button 
            mat-stroked-button 
            class="cancel-btn"
            (click)="resetUpload()">
            <mat-icon>close</mat-icon>
            Cancel
          </button>
          <button 
            mat-raised-button 
            class="use-prompt-btn"
            (click)="useGeneratedPrompt()">
            <mat-icon>check</mat-icon>
            Use This Prompt
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
