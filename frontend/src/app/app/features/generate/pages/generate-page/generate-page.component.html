<div class="generate-layout">
<!-- LEFT: Live Preview (60%) -->
<section class="preview-section">
  <!-- ONLY Add: Title + Template Name + Save/Run Buttons -->
  <!-- <div class="generate-custom-header" *ngIf="hasTemplate() && !(isGenerating$ | async)">
    <div class="header-left">
      <h3>Generated Template</h3>
      <span class="status-badge">
        <mat-icon>check_circle</mat-icon>
        Ready
      </span>
    </div> -->
    
    <!-- Template Name Input -->
    <!-- <mat-form-field class="template-name-input" appearance="outline">
      <mat-label>Template Name</mat-label>
      <input 
        matInput 
        [(ngModel)]="templateName" 
        placeholder="My Email Template"
        maxlength="100">
    </mat-form-field> -->

    <!-- Save Button -->
    <!-- <button
      mat-raised-button
      class="save-btn"
      (click)="onSaveTemplate()"
      [disabled]="(isGenerating$ | async) ?? false">
      <mat-icon>save</mat-icon>
      Save Template
    </button> -->

    <!-- QA Check Button -->
    <!-- <button
      mat-raised-button
      class="run-tests-btn"
      (click)="onRunTests()"
      [disabled]="(isGenerating$ | async) ?? false">
      <mat-icon>visibility</mat-icon>
      QA Check
    </button>
  </div> -->

  <!-- Preview Wrapper -->
  <div class="preview-wrapper">
    <!-- ⭐ FIXED: Always show component, use loading state instead of hiding -->
    <app-template-preview-panel
      [html]="(currentHtml$ | async) || ''"
      [(templateName)]="templateName"
      [loading]="(isGenerating$ | async) ?? false"
      [showHeader]="true"
      [allowRefresh]="false"
      [allowFullscreen]="true"
      [allowViewModes]="true"
      [showGenerateActions]="true"
      [isGeneratePage]="true"
      (saveTemplate)="onSaveTemplate()"
      (runTests)="onRunTests()">
    </app-template-preview-panel>
  </div>
</section>

  <!-- RIGHT: Chat Interface (40%) -->
  <section class="chat-section">
    <div class="chat-header">
      <div class="header-content">
        <!-- Excel Icon SVG -->
        <svg class="header-icon excel-icon" 
             matTooltip="Add Excel/CSV" 
             viewBox="0 0 24 24" 
             xmlns="http://www.w3.org/2000/svg"
             (click)="openCsvBanner()">
          <path fill="#217346" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12.9,14.5L15.8,19H14L12,15.6L10,19H8.2L11.1,14.5L8.2,10H10L12,13.4L14,10H15.8L12.9,14.5Z"/>
        </svg>
        <div class="header-text">
          <h3>Template Generator</h3>
          <p>Powered by AI</p>
        </div>
      </div>

      <!-- New Conversation Button -->
      <button
        mat-icon-button
        class="new-chat-btn"
        (click)="onNewConversation()"
        matTooltip="Start New Conversation"
        [disabled]="(isGenerating$ | async) ?? false">
        <mat-icon>add_circle</mat-icon>
      </button>
      <!-- Usage Tips Button -->
<button
  mat-icon-button
  class="usage-tips-btn"
  [matMenuTriggerFor]="usageMenu"
  matTooltip="How to use">
  <mat-icon>info_outline</mat-icon>
</button>

<!-- Usage Tips Menu -->
<!-- Usage Tips Menu -->
<mat-menu #usageMenu="matMenu" class="usage-tips-menu">
  <div class="usage-tips-content" (click)="$event.stopPropagation()">
    <h4>💡 How to Use This Generator</h4>
    
    <div class="tip-section">
      <strong>Be Specific & Detailed</strong>
      <p>Describe what you want clearly - layout, colors, content sections, and purpose. The more details, the better the result.</p>
    </div>

    <div class="tip-section">
      <strong>📸 Add Design References</strong>
      <p>Upload images (max 2) for visual inspiration - colors, layout, style. We'll match the aesthetic while following your text instructions.</p>
    </div>

    <div class="tip-section">
      <strong>🔖 Request Placeholders</strong>
      <p>Ask for Mailchimp or other placeholders like <code>|*EMAIL*|</code>, <code>|*FNAME*|</code>, <code>|*COMPANY*|</code> - we'll add them where needed.</p>
    </div>

    <div class="tip-section">
      <strong>✨ Example Prompt:</strong>
      <p class="example">"Create a product launch email with a hero image, bold headline, 3-column feature grid, and a centered CTA button. Use purple (#6d28d9) and white colors. Add |*FNAME*| placeholder in greeting."</p>
    </div>

    <div class="tip-note">
      <!-- <mat-icon>mobile_friendly</mat-icon> -->
      All templates are mobile-first & responsive!
    </div>
  </div>
</mat-menu>
    </div>

    <!-- Messages Container -->
<!-- Messages Container -->
<div
  #messagesContainer
  class="chat-messages"
  (scroll)="onScroll($event)">
  
  <!-- Existing messages -->
  <div
    *ngFor="let message of messages$ | async; trackBy: trackByIndex"
    class="chat-msg"
    [class.user-msg]="message.role === 'user'"
    [class.assistant-msg]="message.role === 'assistant'">
    <div class="bubble" [class.user-bubble]="message.role === 'user'">
      <div class="bubble-header">
        <span class="role">{{ message.role === 'user' ? 'You' : 'AI Assistant' }}</span>
        <span class="timestamp">{{ message.timestamp | date: 'short' }}</span>
      </div>
      
      <!-- Images in sent messages -->
      <div class="message-images" *ngIf="message.images && message.images.length > 0">
        <img 
          *ngFor="let img of message.images" 
          [src]="'data:' + img.mediaType + ';base64,' + img.data"
          [alt]="img.fileName"
          class="message-image">
      </div>
      
      <div class="bubble-content">
        {{ message.content }}
      </div>
    </div>
  </div>

  <!-- Image Preview (before sending) -->
  <div class="chat-msg user-msg" *ngIf="imagePreviewUrls.length > 0 && !(isGenerating$ | async)">
    <div class="bubble user-bubble">
      <div class="bubble-header">
        <span class="role">Image Preview</span>
      </div>
      <div class="message-images preview-mode">
        <div *ngFor="let url of imagePreviewUrls; let i = index" class="image-wrapper">
          <img [src]="url" [alt]="'Preview ' + (i + 1)" class="message-image">
          <button class="remove-preview-btn" (click)="removeImage(i)" type="button">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- File Attachment Display (in chat) -->
  <div class="chat-msg user-msg" *ngIf="attachedFile">
    <div class="bubble user-bubble file-attachment-bubble">
      <div class="bubble-header">
        <span class="role">📎 Attached File</span>
        <button 
          mat-icon-button 
          class="remove-attachment-btn-inline"
          (click)="removeAttachedFile()"
          matTooltip="Remove attachment">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="file-attachment-content">
        <div class="file-icon-wrapper">
          <mat-icon class="file-icon">{{ getFileIcon(attachedFile.name) }}</mat-icon>
        </div>
        <div class="file-info">
          <span class="file-name">{{ attachedFile.name }}</span>
          <span class="file-size">{{ formatFileSize(attachedFile.size) }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Generating Indicator -->
  <div class="chat-msg assistant-msg" *ngIf="isGenerating$ | async">
    <div class="bubble generating-bubble">
      <div class="bubble-header">
        <span class="role">AI Assistant</span>
      </div>
      <div class="bubble-content">
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span class="generating-text">{{ isRegenerating ? 'Regenerating template...' : 'Generating template...' }}</span>
      </div>
    </div>
  </div>
</div>

    <!-- Message Composer -->
<!-- Message Composer -->
<!-- Message Composer -->
<div class="composer">
  <!-- Hidden file input -->
  <input 
    type="file"
    id="imageUploadInput"
    accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,image/svg+xml"
    multiple
    [attr.max]="maxImages"
    (change)="onImageSelect($event)"
    style="display: none;">

  <div class="composer-input-row">
    <!-- Plus Button for Image Upload -->
    <button
      mat-icon-button
      class="add-image-btn"
      (click)="triggerFileInput()"
      [disabled]="selectedImages.length >= maxImages || ((isGenerating$ | async) ?? false)"
      [matTooltip]="selectedImages.length >= maxImages ? 'Maximum 2 images' : 'Add design reference images'"
      matTooltipPosition="above"
      type="button">
      <mat-icon>add_photo_alternate</mat-icon>
    </button>

    <textarea
      #messageInput
      class="message-input"
      [(ngModel)]="userInput"
      (keydown.enter)="onEnterKey($event)"
      (paste)="onPaste($event)"
      rows="3">
    </textarea>

    <button
      mat-raised-button
      class="send-btn"
      (click)="onSend()"
      [disabled]="(!userInput.trim() && !attachedFile) || ((isGenerating$ | async) ?? false)">
      <mat-icon>send</mat-icon>
      <span>Send</span>
    </button>
  </div>
</div>
  </section>
</div>
<!-- CSV/Excel Upload Banner -->
<div class="csv-banner-overlay" *ngIf="showCsvBanner" (click)="closeCsvBanner()">
  <div class="csv-banner-content" (click)="$event.stopPropagation()">
    <!-- Close Button -->
    <button mat-icon-button class="close-btn" (click)="closeCsvBanner()">
      <mat-icon>close</mat-icon>
    </button>
    
    <!-- Banner Body -->
    <div class="banner-body">
      <h2 class="banner-title">📄 Upload Document</h2>
      <p class="banner-subtitle">Upload Excel, CSV, Word, or PDF to generate a smart email template prompt</p>
      
      <!-- File Upload Section (Show when no file uploaded or no prompt generated) -->
      <div *ngIf="!uploadedFile && !generatedPrompt" class="upload-section">
        <!-- Hidden file input -->
        <input 
          type="file"
          #fileInput
          accept=".xlsx,.xls,.csv,.doc,.docx,.pdf"
          (change)="onFileSelected($event)"
          style="display: none;">
        
        <!-- Drag & Drop Zone -->
        <div 
          class="drop-zone"
          (click)="fileInput.click()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onFileDrop($event)"
          [class.drag-over]="isDragOver">
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <p class="drop-text">Drag & drop your file here</p>
          <p class="drop-subtext">or click to browse</p>
          <div class="supported-formats">
            <span class="format-badge">Excel</span>
            <span class="format-badge">CSV</span>
            <span class="format-badge">Word</span>
            <span class="format-badge">PDF</span>
          </div>
        </div>
      </div>

      <!-- File Preview Section (Show when file is uploaded but prompt not generated) -->
      <div *ngIf="uploadedFile && !generatedPrompt" class="file-preview-section">
        <div class="file-preview-card">
          <div class="file-icon">
            <mat-icon>{{ getFileIcon(uploadedFile.name) }}</mat-icon>
          </div>
          <div class="file-details">
            <p class="file-name">{{ uploadedFile.name }}</p>
            <p class="file-size">{{ formatFileSize(uploadedFile.size) }}</p>
          </div>
          <button mat-icon-button class="remove-file-btn" (click)="removeUploadedFile()">
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" (click)="$event.stopPropagation()">
          <button 
            mat-raised-button 
            type="button"
            class="generate-prompt-btn"
            (click)="generatePromptFromFile(); $event.stopPropagation()"
            [disabled]="isGeneratingPrompt || isAttachingFile">
            <mat-spinner *ngIf="isGeneratingPrompt" diameter="20"></mat-spinner>
            <mat-icon *ngIf="!isGeneratingPrompt">auto_awesome</mat-icon>
            <span>{{ isGeneratingPrompt ? 'Generating...' : 'Generate Prompt (Recommended)' }}</span>
          </button>

          <button 
            mat-raised-button 
            type="button"
            class="use-in-chat-btn"
            (click)="useFileInChat(); $event.stopPropagation()"
            [disabled]="isGeneratingPrompt || isAttachingFile">
            <mat-spinner *ngIf="isAttachingFile" diameter="20"></mat-spinner>
            <mat-icon *ngIf="!isAttachingFile">attach_file</mat-icon>
            <span>{{ isAttachingFile ? 'Attaching...' : 'Attach Only' }}</span>
          </button>
        </div>
      </div>

      <!-- Prompt Display & Edit Section (Show when prompt is generated) -->
      <div *ngIf="generatedPrompt" class="prompt-section">
        <div class="prompt-header">
          <h3>✨ Generated Prompt</h3>
          <button mat-icon-button (click)="resetUpload()" matTooltip="Upload new file">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>

        <!-- Editable Prompt -->
        <textarea 
          class="prompt-textarea"
          [(ngModel)]="generatedPrompt"
          rows="10"
          placeholder="Edit your prompt here...">
        </textarea>

        <!-- Action Buttons -->
        <div class="prompt-actions">
          <button 
            mat-stroked-button 
            class="cancel-btn"
            (click)="resetUpload()">
            <mat-icon>close</mat-icon>
            Cancel
          </button>
          <button 
            mat-raised-button 
            class="use-prompt-btn"
            (click)="useGeneratedPrompt()">
            <mat-icon>check</mat-icon>
            Use This Prompt
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
