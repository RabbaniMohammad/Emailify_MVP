<div class="campaign-submit-wrapper">
  
  <!-- ============================================ -->
  <!-- STEP 1: MAILCHIMP AUDIENCE SELECTION -->
  <!-- ============================================ -->
  <div class="section-card">
    <div class="card-header">
      <div class="header-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 00-3-3.87m-4-12a4 4 0 010 7.75"/>
        </svg>
      </div>
      <div class="header-text">
        <h3>Select Audience</h3>
        <p>Choose your Mailchimp audience list</p>
      </div>
      <div class="step-badge">Step 1</div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="(audiencesLoading$ | async) === 'loading'">
      <mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
      <p>Loading Mailchimp audiences...</p>
    </div>

    <!-- Error State -->
    <div class="error-state" *ngIf="(audiencesLoading$ | async) === 'error'">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <p>Failed to load audiences</p>
      <button mat-button (click)="loadMailchimpAudiences()">Retry</button>
    </div>

    <!-- Audience List -->
    <div class="audience-list" *ngIf="(audiencesLoading$ | async) === 'success' && audiences.length">
      <div 
        class="audience-item"
        *ngFor="let audience of audiences"
        [class.selected]="selectedAudience?.id === audience.id"
        (click)="selectAudience(audience)">
        <div class="audience-info">
          <div class="audience-name">{{ audience.name }}</div>
          <div class="audience-count">{{ audience.memberCount | number }} members</div>
        </div>
        <div class="check-icon" *ngIf="selectedAudience?.id === audience.id">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="(audiencesLoading$ | async) === 'success' && !audiences.length">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <p>No audiences found</p>
      <small>Create an audience in Mailchimp first</small>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- STEP 2: MASTER DOCUMENT UPLOAD -->
  <!-- ============================================ -->
  <div class="section-card">
    <div class="card-header">
      <div class="header-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
      </div>
      <div class="header-text">
        <h3>Upload Master Document</h3>
        <p>CSV/Excel with: audiences_list, scheduled_time, test_emails, and timezones</p>
      </div>
      <div class="step-badge">Step 2</div>
    </div>

    <!-- Upload Box -->
    <label class="upload-box" [class.disabled]="!selectedAudience">
      <input 
        type="file" 
        accept=".csv,.xlsx,.xls" 
        (change)="onFileUpload($event)" 
        [disabled]="!selectedAudience"
        hidden />
      
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/>
        <polyline points="13 2 13 9 20 9"/>
      </svg>
      
      <div class="upload-text">
        <span class="primary">{{ uploadedFileName || 'Click to upload' }}</span>
        <small>Supports CSV, Excel (.xlsx, .xls)</small>
      </div>

      <!-- Loading Spinner -->
      <mat-progress-spinner 
        *ngIf="(uploadLoading$ | async) === 'loading'"
        diameter="24" 
        mode="indeterminate">
      </mat-progress-spinner>
    </label>

    <!-- Upload Status -->
    <div class="upload-status" *ngIf="(uploadLoading$ | async) === 'success' && masterData.length">
      <div class="status-success">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div class="status-text">
          <strong>{{ masterData.length | number }} rows uploaded</strong>
          <small>{{ testEmails.length }} test email(s) • {{ scheduleGroups.length }} time slot(s)</small>
        </div>
      </div>
    </div>

    <!-- Upload Error -->
    <div class="upload-error" *ngIf="(uploadLoading$ | async) === 'error'">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      <p>Upload failed. Check file format.</p>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- STEP 3: RECONCILIATION RESULTS -->
  <!-- ============================================ -->
  <div class="section-card" *ngIf="reconciliation">
    <div class="card-header">
      <div class="header-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <div class="header-text">
        <h3>Audience Reconciliation</h3>
        <p>Comparison with Mailchimp data</p>
      </div>
      <div class="step-badge">Step 3</div>
    </div>

    <!-- Loading -->
    <div class="loading-state" *ngIf="(reconcileLoading$ | async) === 'loading'">
      <mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
      <p>Reconciling audiences...</p>
    </div>

    <!-- Results -->
    <div class="reconcile-results" *ngIf="(reconcileLoading$ | async) === 'success'">
      <div class="result-grid">
        <!-- Existing -->
        <div class="result-item existing">
          <div class="result-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div class="result-content">
            <div class="result-count">{{ reconciliation.summary.existingCount | number }}</div>
            <div class="result-label">Existing</div>
          </div>
        </div>

        <!-- New -->
        <div class="result-item new">
          <div class="result-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 4v16m8-8H4"/>
            </svg>
          </div>
          <div class="result-content">
            <div class="result-count">{{ reconciliation.summary.newCount | number }}</div>
            <div class="result-label">New</div>
          </div>
        </div>

        <!-- Ignored -->
        <div class="result-item ignored">
          <div class="result-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </div>
          <div class="result-content">
            <div class="result-count">{{ reconciliation.summary.ignoredCount | number }}</div>
            <div class="result-label">Ignored</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ NEW: Add Members Toggle (Only show if new members exist) -->
<div class="add-members-section" *ngIf="reconciliation && reconciliation.summary.newCount > 0">
  <div class="toggle-container">
    <input 
      type="checkbox"
      id="addNewMembers"
      class="toggle-checkbox"
      [(ngModel)]="addNewMembersToAudience" />
    <label for="addNewMembers" class="toggle-label">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
        <circle cx="8.5" cy="7" r="4"/>
        <line x1="20" y1="8" x2="20" y2="14"/>
        <line x1="23" y1="11" x2="17" y2="11"/>
      </svg>
      <small class="toggle-hint">
        Checked: New members saved permanently<br>
        Unchecked: New members archived after campaign sent
        </small>
    </label>
  </div>
  <!-- <small class="toggle-hint">
    If unchecked, emails will only be used for this campaign and not saved to your audience.
  </small> -->
</div>

  <!-- ============================================ -->
  <!-- STEP 4: CAMPAIGN CONFIGURATION -->
  <!-- ============================================ -->
  <div class="section-card" *ngIf="masterData.length">
    <div class="card-header">
      <div class="header-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
      </div>
      <div class="header-text">
        <h3>Campaign Details</h3>
        <p>Subject line and additional content</p>
      </div>
      <div class="step-badge">Step 4</div>
    </div>

    <!-- Subject Line -->
    <div class="input-group">
      <label class="input-label">
        Subject Line <span class="required">*</span>
      </label>
      <div class="input-wrapper">
        <input 
          type="text"
          class="text-input"
          placeholder="Enter email subject..."
          [formControl]="subjectControl"
          maxlength="150" />
        <span class="char-count">{{ getSubjectCharCount() }}</span>
      </div>
      <div class="input-error" *ngIf="subjectControl.touched && subjectControl.invalid">
        Subject line is required
      </div>
    </div>

    <!-- Body Addition (Optional) -->
    <div class="input-group">
      <label class="input-label">
        Additional Content (Optional)
      </label>
      <textarea 
        class="textarea-input"
        placeholder="Add extra information to append to template..."
        [formControl]="bodyAdditionControl"
        rows="4">
      </textarea>
      <small class="input-hint">This will be added to the end of your template HTML</small>
    </div>

<!-- Schedule Preview with Timezone Info -->
<!-- Schedule Preview with Scroll -->
<div class="schedule-preview" *ngIf="scheduleGroups.length">
  <div class="preview-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <polyline points="12 6 12 12 16 14"/>
    </svg>
    <span>{{ scheduleGroups.length }} time slot(s)</span>
  </div>
  
  <!-- ✅ TIMEZONE INFORMATION BANNER WITH SCROLL -->
  <div class="timezone-info-banner" *ngIf="timezoneAnalysis">
    <!-- Warning State: No timezone or mixed -->
    <div class="timezone-warning" *ngIf="shouldShowTimezoneWarning()">
      <!-- <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg> -->
      <div class="warning-content">
        <strong>⏰ Timezone Notice</strong>
        <p>{{ getTimezoneWarningMessage() }}</p>
      </div>
    </div>
    
    <!-- Info State: Single or multiple timezones properly configured -->
    <div class="timezone-info" *ngIf="shouldShowTimezoneInfo()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4m0-4h.01"/>
      </svg>
      <div class="info-content">
        <strong>🌍 Timezone Configuration</strong>
        <p>{{ getTimezoneWarningMessage() }}</p>
      </div>
    </div>
  </div>
  
  <!-- ✅ IMMEDIATE SEND WARNING -->
  <div class="immediate-warning" *ngIf="hasImmediateSends()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
    </svg>
    <div class="warning-text">
      <strong>⚡ Immediate Send</strong>
      <p>{{ getImmediateSendCount() }} recipient(s) have <strong>no schedule time</strong> and will be sent <strong>immediately</strong> when you click "Submit Campaign"</p>
    </div>
  </div>
  
  <!-- ✅ SCROLLABLE Schedule List -->
  <div class="schedule-list-container">
    <div class="schedule-list">
      <div class="schedule-item" 
           *ngFor="let group of scheduleGroups"
           [class.immediate]="group.isImmediate"
           [class.local-timezone]="group.timezoneSource === 'local'">
        
        <div class="schedule-time">
          <!-- Immediate Send -->
          <ng-container *ngIf="group.isImmediate">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
            <strong>Send Immediately</strong>
          </ng-container>
          
          <!-- Scheduled Send -->
          <ng-container *ngIf="!group.isImmediate">
            <div class="time-with-zone">
              <span class="time">{{ group.scheduledTime | date:'short' }}</span>
              <span class="zone" *ngIf="group.timezone">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                {{ group.timezone }}
              </span>
              <span class="zone local-indicator" *ngIf="group.timezoneSource === 'local'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                Local Time
              </span>
            </div>
          </ng-container>
        </div>
        
        <div class="schedule-count">
          {{ group.count }} recipient(s)
        </div>
      </div>
    </div>
  </div>
</div>
  </div>

  <!-- ============================================ -->
  <!-- STEP 5: TEST EMAIL -->
  <!-- ============================================ -->
<!-- ============================================ -->
<!-- STEP 5: TEST EMAIL -->
<!-- ============================================ -->
<div class="section-card" *ngIf="masterData.length">
  <div class="card-header">
    <div class="header-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
      </svg>
    </div>
    <div class="header-text">
      <h3>Test Email</h3>
      <p>{{ testEmails.length }} test recipient(s)</p>
    </div>
    <div class="step-badge">Step 5</div>
  </div>

  <!-- ✅ SHOW WARNING IF NO TEST EMAILS -->
  <div class="no-test-emails-warning" *ngIf="testEmails.length === 0">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
    </svg>
    <div class="warning-content">
      <strong>⚠️ No Test Emails Found</strong>
      <p>Your uploaded file has no test emails in the <code>test_emails</code> column. You can still submit, but testing is highly recommended.</p>
    </div>
  </div>

  <!-- ✅ TEST EMAIL SECTION (ONLY IF EMAILS EXIST) -->
  <div class="test-email-section" *ngIf="testEmails.length > 0">
    <!-- Test Email List Preview -->
    <div class="test-emails-preview">
      <div class="preview-label">Test Recipients:</div>
      <div class="email-chips">
        <span class="email-chip" *ngFor="let email of testEmails.slice(0, 5)">
          {{ email }}
        </span>
        <span class="email-chip more" *ngIf="testEmails.length > 5">
          +{{ testEmails.length - 5 }} more
        </span>
      </div>
    </div>

    <!-- ✅ TEST EMAIL BUTTON (ENABLED ONLY IF EMAILS EXIST) -->
<button 
  mat-raised-button
  class="test-email-btn"
  (click)="sendTestEmail()"
  [disabled]="!canSendTest || (testEmailLoading$ | async) === 'loading'"
  [matTooltip]="getTestEmailTooltip()"
  [matTooltipDisabled]="canSendTest"
  matTooltipPosition="above"
  matTooltipShowDelay="300">
  <mat-progress-spinner
    *ngIf="(testEmailLoading$ | async) === 'loading'"
    diameter="18"
    mode="indeterminate">
  </mat-progress-spinner>
  <!-- <svg *ngIf="(testEmailLoading$ | async) !== 'loading'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
  </svg> -->
  <span>{{ (testEmailLoading$ | async) === 'loading' ? 'Sending...' : 'Send Test Email' }}</span>
</button>

    <!-- Test Email Status -->
    <div class="test-status" *ngIf="testEmailSent">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <span>Test email sent {{ getTestEmailsSentTime() }}</span>
    </div>
  </div>

  <!-- ✅ DISABLED TEST BUTTON IF NO EMAILS -->
  <div class="test-email-section" *ngIf="testEmails.length === 0">
    <button 
      mat-raised-button
      class="test-email-btn disabled"
      disabled
      matTooltip="No test emails found in uploaded file">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18M6 6l12 12"/>
      </svg>
      <span>Test Email Unavailable</span>
    </button>
  </div>
</div>

  <!-- ============================================ -->
  <!-- STEP 6: FINAL SUBMIT -->
  <!-- ============================================ -->
<!-- ✅ STEP 6: FINAL SUBMIT (ALWAYS VISIBLE) -->
<div class="submit-section">
  <button 
    mat-raised-button
    class="submit-btn"
    (click)="onSubmit()"
    [disabled]="!canSubmit || (submitLoading$ | async) === 'loading'">
    <mat-progress-spinner
      *ngIf="(submitLoading$ | async) === 'loading'"
      diameter="20"
      mode="indeterminate">
    </mat-progress-spinner>
    <!-- <svg *ngIf="(submitLoading$ | async) !== 'loading'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M5 12h14M12 5l7 7-7 7"/>
    </svg> -->
    <span>{{ (submitLoading$ | async) === 'loading' ? 'Submitting...' : 'Submit Campaign' }}</span>
  </button>

  <!-- ⚠️ Warning Banner -->
  <div class="warning-banner" *ngIf="testEmails.length === 0 && masterData.length > 0">
    <!-- <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
    </svg> -->
    <span>⚠️ No test emails available - Campaign will be submitted untested</span>
  </div>

  <div class="warning-banner" *ngIf="!testEmailSent && testEmails.length > 0">
    <!-- <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
    </svg> -->
    <span>⚠️ Test email not sent - Extra confirmation will be required</span>
  </div>
</div>

</div>