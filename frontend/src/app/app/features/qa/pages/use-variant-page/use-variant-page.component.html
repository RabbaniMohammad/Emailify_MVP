<!-- Animated Background -->
<div class="page-background">
  <div class="gradient-orb orb-1"></div>
  <div class="gradient-orb orb-2"></div>
  <div class="gradient-orb orb-3"></div>
</div>

<div class="use-variant-wrapper" [class.editor-mode]="editorOpen$ | async">
  <div class="use-grid">
    <!-- Left: live preview -->
    <section class="use-left glass-card" [class.minimized]="editorOpen$ | async">
      <div class="section-header">
        <h3>Selected Variant</h3>
        <!-- NEW: Open Editor Button -->
        <button 
          mat-icon-button 
          class="editor-toggle-btn"
          (click)="openEditor()" 
          *ngIf="!(editorOpen$ | async)"
          matTooltip="Use this editor for minor updates. For major changes, use Figma"
          matTooltipPosition="below">
          <mat-icon>edit_note</mat-icon>
        </button>
      </div>
      <div class="preview-wrapper">
        <app-html-preview
          [html]="(html$ | async) || ''"
          [loading]="loadingVariant">
        </app-html-preview>
      </div>
    </section>

    <!-- Right: Chat OR Editor -->
    <section class="use-right glass-card" [class.editor-expanded]="editorOpenSync">
      <!-- Chat Interface -->
      <ng-container *ngIf="!editorOpenSync">
        <div class="chat-section" @fadeInOut>
          <div class="section-header">
            <h3>AI Assistant</h3>
            <button
              mat-raised-button
              class="finalize-btn"
              (click)="onFinalize()"
              [disabled]="finalizing$ | async">
              <mat-progress-spinner
                *ngIf="finalizing$ | async"
                diameter="16"
                mode="indeterminate"
                class="btn-spinner">
              </mat-progress-spinner>
              <span>{{ (finalizing$ | async) ? 'Finalizing...' : 'Finalize' }}</span>
            </button>
          </div>

          <div class="chat-container">
            <div class="chat-messages" #chatMessages>
              <div
                class="chat-msg"
                *ngFor="let m of (messages$ | async) ?? []; let i = index; trackBy: trackByMsg">
                <div class="bubble" [class.me]="m.role === 'user'">
                  <div class="who">{{ m.role === 'user' ? 'YOU' : 'AI ASSISTANT' }}</div>
                  <div class="text" [innerText]="m.text"></div>

                  <ng-container *ngIf="m.role === 'assistant' && m.json?.edits?.length">
                    <div class="apply-panel">
                      <div class="apply-header">
                        <h4>Suggested Changes ({{ m.json?.edits?.length || 0 }})</h4>
                        <div class="actions-row">
                          <button
                            mat-button
                            class="clear-btn"
                            (click)="onClearEdits(i)"
                            [disabled]="applyingIndex === i">
                            Clear
                          </button>
                          <button
                            mat-raised-button
                            class="apply-all-btn"
                            [disabled]="applyingIndex === i"
                            (click)="onApplyEdits(i)">
                            <mat-progress-spinner
                              *ngIf="applyingIndex === i"
                              diameter="16"
                              mode="indeterminate">
                            </mat-progress-spinner>
                            <span>{{ applyingIndex === i ? 'Applying...' : 'Apply All' }}</span>
                          </button>
                        </div>
                      </div>

                      <div class="apply-list">
                        <div class="apply-item"
                             *ngFor="let e of m.json!.edits; let j = index">
                          <div class="edit-row">
                            <div class="edit-col">
                              <div class="label">Original</div>
                              <div class="orig">{{ e.find }}</div>
                            </div>
                            <div class="arrow-col">→</div>
                            <div class="edit-col">
                              <div class="label">Replacement</div>
                              <input
                                type="text"
                                class="replacement-input"
                                [value]="e.replace"
                                #repInput />
                            </div>
                          </div>

                          <div class="edit-actions">
                            <button
                              mat-stroked-button
                              class="apply-single-btn"
                              (click)="onApplySingle(i, e, repInput.value)"
                              [disabled]="applyingIndex === i">
                              Apply
                            </button>
                            <button
                              mat-button
                              class="skip-btn"
                              (click)="onSkipSingle(i, j)"
                              [disabled]="applyingIndex === i">
                              Skip
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>

            <div class="composer">
              <textarea
                class="message-input"
                [formControl]="input"
                placeholder="Ask for changes or ideas..."
                rows="2"
                (keydown)="handleKeyDown($event)">
              </textarea>
              <button
                mat-raised-button
                class="send-btn"
                (click)="onSend()"
                [disabled]="sending || !input.value.trim()">
                <mat-progress-spinner
                  *ngIf="sending"
                  diameter="18"
                  mode="indeterminate">
                </mat-progress-spinner>
                <svg *ngIf="!sending" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- HTML Editor (shown when editor open) -->
      <ng-container *ngIf="editorOpen$ | async">
        <app-html-editor 
          [initialHtml]="(html$ | async) || ''"
          (htmlChanged)="onEditorSave($event)"
          (editorClosed)="onEditorClose()">
        </app-html-editor>
      </ng-container>
    </section>
  </div>

  <!-- Finalize section -->
  <section id="finalize" class="finalize-section glass-card">
    <div class="finalize-header">
      <div class="header-content">
        <h3>Finalize & Validate</h3>
        <p>Capture screenshots and validate links against your source file</p>
      </div>
    </div>

    <div class="finalize-grid">
      <!-- Left: Screenshots -->
      <div class="screenshots-col">
        <div class="col-header">
          <h4>Link Screenshots</h4>
          <div class="quick-capture">
            <input
              type="text"
              placeholder="Paste URL to test"
              #newUrl
              (keyup.enter)="captureUrl(newUrl)" />
            <button
              mat-icon-button
              class="capture-btn"
              (click)="captureUrl(newUrl)"
              matTooltip="Capture Screenshot">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Loading state wrapper -->
        <div class="snaps-list-wrapper" [class.loading]="finalizing$ | async">
          <!-- Loading overlay -->
          <div class="loading-overlay" *ngIf="finalizing$ | async" @fadeInOut>
            <div class="loading-content">
              <mat-progress-spinner
                diameter="48"
                mode="indeterminate"
                class="main-spinner">
              </mat-progress-spinner>
              <p class="loading-text">Capturing screenshots...</p>
              <small class="loading-subtext">This may take a moment</small>
            </div>
          </div>

          <!-- Existing snaps list -->
          <div class="snaps-list" *ngIf="(snaps$ | async) as snaps">
            <div *ngIf="!snaps.length && !(finalizing$ | async)" class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <p>No screenshots yet</p>
              <small>Click "Finalize" or paste a URL above</small>
            </div>

            <div class="snap-item" *ngFor="let s of snaps; trackBy: trackBySnap">
              <div class="snap-preview" (click)="openImageModal(s)" style="cursor: pointer;">
                <ng-container *ngIf="s.dataUrl; else snapLoading">
                  <img [src]="s.dataUrl" alt="Screenshot" />
                </ng-container>
                <ng-template #snapLoading>
                  <div class="snap-loading" *ngIf="!s.error">
                    <mat-progress-spinner diameter="24" mode="indeterminate"></mat-progress-spinner>
                  </div>
                  <div class="snap-error" *ngIf="s.error">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <span>Failed</span>
                  </div>
                </ng-template>
              </div>
              <div class="snap-info">
                <div class="snap-url-container">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <a [href]="s.finalUrl || s.url" target="_blank" class="snap-url">
                      {{ s.finalUrl || s.url }}
                    </a>
                    
                    <!-- Edit icon button -->
                    <button 
                      mat-icon-button 
                      class="edit-snap-btn"
                      (click)="onEditSnap(s)"
                      matTooltip="Edit URL">
                      <mat-icon>edit</mat-icon>
                    </button>
                  </div>
                  
                  <!-- ✅ FIXED: Only show status when loaded (has dataUrl) or errored (has error) -->
                  <div class="snap-meta" *ngIf="s.dataUrl || s.error">
                    <span class="status-badge" [class.ok]="s.ok" [class.fail]="!s.ok">
                      {{ s.ok ? 'OK' : 'Failed' }}
                      <ng-container *ngIf="s.status"> · {{ s.status }}</ng-container>
                    </span>
                  </div>
                </div>
                
                <!-- ✅ Inline edit input with Replace (dummy) and Retest buttons + Enter key support -->
                <div class="snap-edit-input" *ngIf="isSnapInEditMode(s)">
  <!-- URL Info Labels -->
  <div class="url-info-labels">
    <div class="url-label-row">
      <span class="url-label-title">Original Link:</span>
      <span class="url-label-value">{{ getOriginalUrl(s) }}</span>
    </div>
    <div class="url-label-row" *ngIf="hasBeenRetested(s)">
      <span class="url-label-title">Latest Tested Link:</span>
      <span class="url-label-value success">{{ getLatestTestedUrl(s) }}</span>
    </div>
  </div>
  
  <input 
  type="text"
  placeholder="Paste or type new URL here"
  [(ngModel)]="editInputValue"
  (keydown)="onEditInputKeyDown($event, s, editUrlInput)"
  #editUrlInput />
  
  <!-- ✅ Replace button - NOW FUNCTIONAL -->
  <button 
    mat-stroked-button 
    class="replace-btn"
    (click)="onReplaceSnap(s, editUrlInput)"
    [disabled]="!canReplace(s)">
    Replace
  </button>
  
  <!-- ✅ Retest button -->
  <button
    mat-stroked-button
    class="retest-btn-inline"
    (click)="onRetestUrl(s.finalUrl || s.url, editUrlInput.value)"
    [disabled]="isSnapping(editUrlInput.value || s.finalUrl || s.url)">
    <mat-progress-spinner
      *ngIf="isSnapping(editUrlInput.value || s.finalUrl || s.url)"
      diameter="16"
      mode="indeterminate">
    </mat-progress-spinner>
    <span *ngIf="!isSnapping(editUrlInput.value || s.finalUrl || s.url)">Test</span>
  </button>
</div>
                
                <!-- Regular Retest button (when not in edit mode) -->
                <button
                  *ngIf="!isSnapInEditMode(s)"
                  mat-button
                  class="retest-btn"
                  (click)="onRetestUrl(s.finalUrl || s.url)"
                  [disabled]="isSnapping(s.finalUrl || s.url)">
                  <mat-progress-spinner
                    *ngIf="isSnapping(s.finalUrl || s.url)"
                    diameter="16"
                    mode="indeterminate">
                  </mat-progress-spinner>
                  <span *ngIf="!isSnapping(s.finalUrl || s.url)">Retest</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Validation -->
      <div class="validation-col">
        <div class="col-header">
          <h4>Link Validation</h4>
        </div>

        <div class="upload-section">
          <label class="upload-label">
            <input type="file" accept=".csv,.xlsx,.xls" (change)="onValidLinksUpload($event)" hidden />
            <div class="upload-box">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              <span>Upload CSV/Excel</span>
              <small>Must have "valid links" column</small>
            </div>
          </label>

          <div *ngIf="(validLinks$ | async) as vlinks" class="upload-status">
            <div *ngIf="vlinks.length" class="status-success">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              {{ vlinks.length }} valid link(s) loaded
            </div>
          </div>
        </div>

        <div class="validation-results" *ngIf="(linkChecks$ | async) as checks">
          <div *ngIf="checks.length" class="results-header">
            <h5>Validation Results</h5>
            <span class="count">{{ checks.length }} link(s)</span>
          </div>

          <div class="validation-grid" *ngIf="checks.length">
            <div class="validation-item" *ngFor="let c of checks"
                 [class.valid]="c.inHtml && c.inFile"
                 [class.invalid]="!c.inHtml || !c.inFile">
              <div class="validation-status">
                <svg *ngIf="c.inHtml && c.inFile" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <svg *ngIf="!c.inHtml && c.inFile" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <svg *ngIf="c.inHtml && !c.inFile" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
              </div>
              <div class="validation-content">
                <a [href]="c.url" target="_blank" class="validation-url">{{ c.url }}</a>
                <div class="validation-reason" *ngIf="c.inFile && !c.inHtml">Missing from HTML</div>
                <div class="validation-reason" *ngIf="!c.inFile && c.inHtml">Extra link in HTML</div>
              </div>
              <button
                mat-icon-button
                class="capture-mini-btn"
                (click)="onRetestUrl(c.url)"
                matTooltip="Capture">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                </svg>
              </button>
            </div>
          </div>

          <div *ngIf="!checks.length" class="no-results">
            Upload a file to see validation results
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Fullscreen Image Modal -->
  <div class="image-modal" *ngIf="selectedImage" (click)="closeImageModal()">
    <div class="modal-backdrop"></div>
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeImageModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <img [src]="selectedImage.dataUrl" [alt]="selectedImage.url" />
      <div class="modal-info">
        <a [href]="selectedImage.url" target="_blank">{{ selectedImage.url }}</a>
      </div>
    </div>
  </div>
</div>