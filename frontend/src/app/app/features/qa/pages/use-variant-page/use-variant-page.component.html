<div class="use-grid">
  <!-- Left: live preview -->
  <section class="use-left">
    <h3>Selected variant</h3>
    <app-html-preview
      [html]="(html$ | async) || ''"
      [loading]="loadingVariant">
    </app-html-preview>
  </section>

  <!-- Right: Chat -->
  <section class="use-right">
    <!-- Header row with Finalize button -->
    <div class="flex items-center justify-between">
      <h3>Assistant</h3>
      <button
        mat-raised-button
        color="accent"
        (click)="onFinalize()">
        Finalize template
      </button>
    </div>

    <div class="chat">
      <!-- Thread -->
      <div
        class="chat-msg"
        *ngFor="let m of (messages$ | async) ?? []; let i = index; trackBy: trackByMsg">
        <div class="bubble" [class.me]="m.role === 'user'">
          <div class="who">{{ m.role === 'user' ? 'You' : 'Assistant' }}</div>
          <div class="text" [innerText]="m.text"></div>

          <!-- Apply panel (keeps UI minimal; no before/after contexts shown) -->
          <ng-container *ngIf="m.role === 'assistant' && m.json?.edits?.length">
            <div class="apply-panel">
              <div class="apply-header">
                <h4>Apply changes</h4>
                <div class="actions-row">
                  <button
                    mat-stroked-button
                    (click)="onClearEdits(i)"
                    [disabled]="applyingIndex === i">
                    Clear
                  </button>
                  <button
                    mat-raised-button
                    color="primary"
                    class="apply-btn"
                    [disabled]="applyingIndex === i"
                    (click)="onApplyEdits(i)">
                    <mat-icon *ngIf="applyingIndex !== i">done_all</mat-icon>
                    <mat-progress-spinner
                      *ngIf="applyingIndex === i"
                      diameter="16"
                      mode="indeterminate">
                    </mat-progress-spinner>
                    <span>Apply all</span>
                  </button>
                </div>
              </div>

              <div class="apply-list">
                <div class="apply-item rounded-lg border p-3"
                     *ngFor="let e of m.json!.edits; let j = index">
                  <div class="label text-sm text-neutral-500 mb-1">Original</div>
                  <div class="orig rounded bg-neutral-50 p-2 text-sm break-words">
                    {{ e.find }}
                  </div>

                  <div class="label text-sm text-neutral-500 mt-3 mb-1">
                    Suggested (you can edit)
                  </div>
                  <input
                    class="w-full rounded border p-2"
                    [value]="e.replace"
                    #repInput />

                  <div class="mt-3 flex gap-2">
                    <button
                      mat-stroked-button
                      color="primary"
                      (click)="onApplySingle(i, e, repInput.value)"
                      [disabled]="applyingIndex === i">
                      Apply
                    </button>
                    <button
                      mat-button
                      (click)="onSkipSingle(i, j)"
                      [disabled]="applyingIndex === i">
                      Skip
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Composer (reactive) -->
      <div class="composer">
        <mat-form-field appearance="outline" class="w100">
          <textarea
            matInput
            [formControl]="input"
            rows="3"
            placeholder="Ask for ideas or request a change (e.g., ‘tighten the headline’)">
          </textarea>
        </mat-form-field>

        <div class="send-row">
          <button
            mat-raised-button
            color="primary"
            (click)="onSend()"
            [disabled]="sending || !input.value?.trim()">
            <mat-icon *ngIf="!sending">send</mat-icon>
            <mat-progress-spinner
              *ngIf="sending"
              diameter="16"
              mode="indeterminate">
            </mat-progress-spinner>
            <span>Send</span>
          </button>
        </div>
      </div>
      <!-- /Composer -->
    </div>
  </section>
</div>

<!-- ↓↓↓ Finalize section (scroll target) ↓↓↓ -->
<section id="finalize" class="mt-8">
  <h3>Finalize template</h3>
  <p class="text-sm text-neutral-600">
    Review and validate links with live screenshots. Each capture is added as soon as it finishes.
  </p>

  <div class="finalize-grid">
    <!-- Left column: links -> screenshots -->
    <div class="col">
      <div class="row header">
        <h4>Links & screenshots</h4>

        <!-- Quick tester -->
        <div class="inline-form">
          <input
            placeholder="Paste a link to test…"
            #newUrl
            (keyup.enter)="onSnapUrl(newUrl.value); newUrl.value=''" />
          <button
            mat-raised-button
            color="primary"
            (click)="onSnapUrl(newUrl.value); newUrl.value=''">
            Capture
          </button>
        </div>
      </div>

      <div class="snaps" *ngIf="(snaps$ | async) as snaps">
        <div *ngIf="!snaps.length" class="empty">
          No screenshots yet. Click “Finalize template” to capture all links from this variant, or paste a link above.
        </div>

        <div class="snap-card" *ngFor="let s of snaps; trackBy: trackBySnap">
          <div class="snap-head">
            <div class="url">
              <a [href]="s.finalUrl || s.url" target="_blank" rel="noopener">{{ s.finalUrl || s.url }}</a>
              <span class="chip" [class.ok]="s.ok" [class.fail]="!s.ok">
                {{ s.ok ? 'OK' : 'Fail' }}<ng-container *ngIf="s.status"> · {{ s.status }}</ng-container>
              </span>
            </div>
            <div class="ts">{{ s.ts | date:'short' }}</div>
          </div>

          <div class="snap-body">
            <ng-container *ngIf="s.dataUrl; else loadingOrError">
              <img class="snap-thumb" [src]="s.dataUrl" alt="Screenshot" />
            </ng-container>
            <ng-template #loadingOrError>
              <div class="snap-skel" *ngIf="!s.error">
                <mat-progress-spinner diameter="24" mode="indeterminate"></mat-progress-spinner>
                <span>Capturing…</span>
              </div>
              <div class="snap-err" *ngIf="s.error">
                <mat-icon>error_outline</mat-icon>
                <span>{{ s.error }}</span>
              </div>
            </ng-template>
          </div>

          <div class="snap-actions">
            <button mat-stroked-button color="primary"
                    (click)="onRetestUrl(s.finalUrl || s.url)"
                    [disabled]="isSnapping(s.finalUrl || s.url)">
              Retest
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column: upload & validation -->
    <div class="col">
      <h4>Validation</h4>
      <p class="text-sm text-neutral-600">
        Upload a CSV/XLSX with a column named <strong>valid links</strong>.
        We’ll compare it to the links found in this variant’s HTML.
      </p>

      <!-- Upload control -->
      <div class="inline-form" style="margin-bottom:10px">
        <input type="file" accept=".csv,.xlsx,.xls"
               (change)="onValidLinksUpload($event)" />
        <small class="text-sm text-neutral-500">Header must be exactly: <code>valid links</code></small>
      </div>

      <!-- File summary -->
      <div *ngIf="(validLinks$ | async) as vlinks">
        <div class="text-sm" *ngIf="vlinks.length; else noFile">
          Loaded {{ vlinks.length }} link(s) from file.
        </div>
        <ng-template #noFile>
          <div class="text-sm text-neutral-500">No file loaded yet.</div>
        </ng-template>
      </div>

      <!-- Comparison list -->
      <div *ngIf="(linkChecks$ | async) as checks">
        <div *ngIf="checks.length; else noChecks">
          <div class="edits-title">Results</div>
          <ul class="edits-list">
            <li *ngFor="let c of checks">
              <mat-icon
                [ngClass]="{ 'text-green-600': (c.inHtml && c.inFile), 'text-red-600': (!c.inHtml && c.inFile) }">
                {{ (c.inHtml && c.inFile) ? 'check_circle' : (!c.inHtml && c.inFile) ? 'cancel' : 'help_outline' }}
              </mat-icon>
              <a [href]="c.url" target="_blank" rel="noopener">{{ c.url }}</a>
              <span class="reason" *ngIf="c.inFile && !c.inHtml"> — not found in HTML</span>
              <span class="reason" *ngIf="!c.inFile && c.inHtml"> — extra link in HTML</span>
              <button class="ml-2" mat-button color="primary"
                      (click)="onRetestUrl(c.url)">Capture</button>
            </li>
          </ul>
        </div>
        <ng-template #noChecks>
          <div class="text-sm text-neutral-500">Upload a file to see results.</div>
        </ng-template>
      </div>

      <p class="text-sm text-neutral-600" style="margin-top:12px">
        If a link seems wrong, paste a corrected URL in the box on the left — it will be tested and added immediately.
        <br />
        Refresh-safe: screenshots are stored per run and reloaded on page open.
      </p>
    </div>
  </div>
</section>
